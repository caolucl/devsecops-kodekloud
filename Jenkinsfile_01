pipeline {
  agent any

  environment {
    deploymentName = "devsecops"
    containerName = "devsecops-container"
    serviceName = "devsecops-svc"
    imageName = "siddharth67/numeric-app:${GIT_COMMIT}"
    applicationURL="http://devsecops-demo.eastus.cloudapp.azure.com"
    applicationURI="/increment/99"
  }

  stages {

     stage('Build Artifact - Maven') {
       steps {
         sh "mvn clean package -DskipTests=true"
         archive 'target/*.jar'
       }
     }
     stage('Unit Tests - JUnit and JaCoCo') {
       steps {
         sh "mvn test"
       }
       post {
        always{
          junit 'target/surefire-reports/*.xml'
          jacoco execPattern: 'target/jacoco.exec'
         }
       }
    }
    stage('Docker Build and Push') {
      steps {
         withDockerRegistry([credentialsId: "dockerhub-caolucl", url: ""]) {
           sh 'printenv'
           sh 'sudo docker build -t caolucl/numeric-app:""$GIT_COMMIT"" .'
           sh 'docker push caolucl/numeric-app:""$GIT_COMMIT""'
         }
       }
     }
  }
}
      

